@model TechWayFit.Licensing.WebUI.ViewModels.License.LicenseValidationViewModel
@{
    ViewData["Title"] = "Validate License";
}

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h4 class="card-title mb-0">
                    <i class="fas fa-shield-alt me-2"></i>
                    Validate License
                </h4>
            </div>
            <div class="card-body">
                <form asp-action="ValidateLicense" method="post">
                    <div class="mb-3">
                        <label asp-for="LicenseJson" class="form-label"></label>
                        <textarea asp-for="LicenseJson" class="form-control" rows="10" 
                                  placeholder="Paste your license JSON here..."></textarea>
                        <span asp-validation-for="LicenseJson" class="text-danger"></span>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Paste the complete license JSON content from your license file.
                        </div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-secondary" onclick="clearForm()">
                            <i class="fas fa-eraser me-1"></i>Clear
                        </button>
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-check-circle me-1"></i>Validate License
                        </button>
                    </div>
                </form>
            </div>
        </div>

        @if (Model.IsValid.HasValue)
        {
            <div class="card mt-4">
                <div class="card-header @(Model.IsValid.Value ? "bg-success text-white validation-success" : "bg-danger text-white validation-error")">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-@(Model.IsValid.Value ? "check-circle" : "times-circle") me-2"></i>
                        Validation Result
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-@(Model.IsValid.Value ? "success" : "danger")" role="alert">
                        <strong>@Model.ValidationMessage</strong>
                    </div>

                    @if (Model.IsValid.Value && Model.License != null)
                    {
                        <h6>License Information:</h6>
                        <dl class="row">
                            <dt class="col-sm-3">Licensed To:</dt>
                            <dd class="col-sm-9">@Model.License.LicensedTo</dd>

                            <dt class="col-sm-3">License ID:</dt>
                            <dd class="col-sm-9"><code>@Model.License.LicenseId</code></dd>

                            <dt class="col-sm-3">Contact Person:</dt>
                            <dd class="col-sm-9">@Model.License.ContactPerson (@Model.License.ContactEmail)</dd>

                            <dt class="col-sm-3">License Tier:</dt>
                            <dd class="col-sm-9">
                                <span class="badge bg-@(Model.License.Tier == TechWayFit.Licensing.Core.Models.LicenseTier.Community ? "success" : 
                                                      Model.License.Tier == TechWayFit.Licensing.Core.Models.LicenseTier.Professional ? "primary" : "warning")">
                                    @Model.License.Tier
                                </span>
                            </dd>

                            <dt class="col-sm-3">Valid Period:</dt>
                            <dd class="col-sm-9">
                                @Model.License.ValidFrom.ToString("yyyy-MM-dd") to @Model.License.ValidTo.ToString("yyyy-MM-dd")
                                @if (Model.License.IsValid)
                                {
                                    <span class="badge bg-success ms-2">Currently Valid</span>
                                }
                                else
                                {
                                    <span class="badge bg-danger ms-2">Expired</span>
                                }
                            </dd>

                            <dt class="col-sm-3">Expires In:</dt>
                            <dd class="col-sm-9">
                                @if (Model.License.IsValid)
                                {
                                    var daysLeft = (Model.License.ValidTo - DateTime.UtcNow).Days;
                                    if (daysLeft > 30)
                                    {
                                        <span class="text-success">@daysLeft days</span>
                                    }
                                    else if (daysLeft > 7)
                                    {
                                        <span class="text-warning">@daysLeft days</span>
                                    }
                                    else
                                    {
                                        <span class="text-danger">@daysLeft days</span>
                                    }
                                }
                                else
                                {
                                    <span class="text-danger">Expired</span>
                                }
                            </dd>

                            <dt class="col-sm-3">Issued:</dt>
                            <dd class="col-sm-9">@Model.License.IssuedAt.ToString("yyyy-MM-dd HH:mm:ss") UTC</dd>
                        </dl>

                        <h6 class="mt-4">Enabled Features:</h6>
                        <div class="row">
                            @foreach (var feature in Model.License.FeaturesIncluded.Where(f => f.IsEnabled))
                            {
                                <div class="col-md-6 mb-2">
                                    <div class="card border-success">
                                        <div class="card-body py-2">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-check text-success me-2"></i>
                                                <div>
                                                    <strong>@feature.Name</strong>
                                                    <span class="badge bg-secondary ms-2">@feature.Category</span>
                                                    <br>
                                                    <small class="text-muted">@feature.Description</small>
                                                    @if (feature.Limits != null)
                                                    {
                                                        <br>
                                                        <small class="text-info">
                                                            @if (feature.Limits.MaxUsagePerMonth.HasValue)
                                                            {
                                                                <span>Max: @feature.Limits.MaxUsagePerMonth/month</span>
                                                            }
                                                            @if (feature.Limits.MaxConcurrentUsage.HasValue)
                                                            {
                                                                <span>Concurrent: @feature.Limits.MaxConcurrentUsage</span>
                                                            }
                                                        </small>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        }
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-question-circle me-2"></i>
                    How to Validate
                </h5>
            </div>
            <div class="card-body">
                <ol>
                    <li>Open your license file (usually ending in <code>.json</code>)</li>
                    <li>Copy the entire content of the file</li>
                    <li>Paste it into the text area on the left</li>
                    <li>Click "Validate License" to check its validity</li>
                </ol>
                
                <hr>
                
                <h6><i class="fas fa-shield-alt me-1"></i> What We Check:</h6>
                <ul class="list-unstyled">
                    <li><i class="fas fa-check text-success me-1"></i> Digital signature integrity</li>
                    <li><i class="fas fa-check text-success me-1"></i> License expiration date</li>
                    <li><i class="fas fa-check text-success me-1"></i> License format validity</li>
                    <li><i class="fas fa-check text-success me-1"></i> Feature permissions</li>
                </ul>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header bg-secondary text-white">
                <h6 class="card-title mb-0">
                    <i class="fas fa-lightbulb me-2"></i>
                    Sample License Format
                </h6>
            </div>
            <div class="card-body">
                <small>Your license JSON should look similar to:</small>
                <div class="bg-light p-2 mt-2 rounded">
                    <code style="font-size: 0.8rem;">
{<br>
&nbsp;&nbsp;"licenseData": "base64...",<br>
&nbsp;&nbsp;"signature": "...",<br>
&nbsp;&nbsp;"signatureAlgorithm": "RS256",<br>
&nbsp;&nbsp;"publicKeyThumbprint": "...",<br>
&nbsp;&nbsp;"formatVersion": "1.0",<br>
&nbsp;&nbsp;"createdAt": "...",<br>
&nbsp;&nbsp;"checksum": "..."<br>
}
                    </code>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="d-flex justify-content-center">
            <a href="@Url.Action("Index", "License")" class="btn btn-primary">
                <i class="fas fa-plus me-1"></i>Generate New License
            </a>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function clearForm() {
            $('#LicenseJson').val('');
        }

        // Auto-format JSON when pasted
        $('#LicenseJson').on('paste', function() {
            setTimeout(function() {
                try {
                    var content = $('#LicenseJson').val();
                    var parsed = JSON.parse(content);
                    var formatted = JSON.stringify(parsed, null, 2);
                    $('#LicenseJson').val(formatted);
                } catch (e) {
                    // If it's not valid JSON, leave it as is
                }
            }, 100);
        });
    </script>
}
