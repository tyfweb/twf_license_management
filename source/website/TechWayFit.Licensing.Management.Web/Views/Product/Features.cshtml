@model TechWayFit.Licensing.Management.Web.ViewModels.Product.ProductEnhancedEditViewModel

@{
    ViewData["Title"] = "Product Features - " + Model.ProductName;
    ViewData["Description"] = "Manage product features, dependencies, and feature tiers";
}

@section Styles {
    <style>
        .product-icon {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(13, 110, 253, 0.1);
            border-radius: 10px;
        }

        .feature-category {
            margin-bottom: 2rem;
        }

        .category-title {
            color: #495057;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }

        .feature-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            border: 1px solid #e9ecef;
        }

        .feature-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* Modal Enhancements */
        .modal-xl {
            max-width: 900px;
        }

        .modal-header.bg-primary {
            border-bottom: none;
        }

        .modal-content {
            border: none;
            border-radius: 0.5rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }

        .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }

        .modal-footer.bg-light {
            border-top: 1px solid #e9ecef;
            border-bottom-left-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
        }

        /* Form Section Headers */
        .modal-body h6 {
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e9ecef;
        }

        /* Enhanced Cards for Status Settings */
        .card.border-success {
            border-width: 2px;
        }

        .card.border-primary {
            border-width: 2px;
        }

        .card.border-info {
            border-width: 2px;
        }        /* Form Controls */
        .form-label.fw-semibold {
            font-weight: 600;
            color: #495057;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }

        /* Modal Enhancements */
        .modal-header {
            border-bottom: 1px solid #dee2e6;
        }

        .modal-footer {
            border-top: 1px solid #dee2e6;
        }

        /* Button Enhancements */
        .modal-footer .btn {
            padding: 0.5rem 1.5rem;
            font-weight: 500;
        }
    </style>
}

<div class="container-fluid py-3">
    <!-- Header Section -->
    <div class="header mb-3">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-1">Product Features</h2>
                <p class="text-muted mb-0">Manage features, capabilities and tier assignments for @Model.ProductName.
                </p>
            </div>
            <div class="btn-group" role="group">
                <a href="@Url.Action("Details", new { id = Model.ProductId })" class="btn btn-outline-primary">
                    <i class="fas fa-info-circle me-1"></i>Basic Details
                </a>
                <a href="@Url.Action("Tiers", new { id = Model.ProductId })" class="btn btn-outline-primary">
                    <i class="fas fa-layer-group me-1"></i>Tiers
                </a>
                <a href="@Url.Action("Index", "ProductVersion", new { productId = Model.ProductId })" class="btn btn-outline-primary">
                    <i class="fas fa-code-branch me-1"></i>Versions
                </a>
                <a href="@Url.Action("Index", "ProductFeature", new { productId = Model.ProductId })" class="btn btn-primary">
                    <i class="fas fa-star me-1"></i>Features
                </a>
            </div>
        </div>
    </div>

    <!-- Product Info Card -->
    <div class="row g-2 mb-3">
        <div class="col-12">
            <div class="sidebar-section">
                <div class="section-header">
                    <div class="d-flex align-items-center">
                        <div class="product-icon me-3" style="width: 40px; height: 40px;">
                            <i class="fas fa-cube text-primary"></i>
                        </div>
                        <div>
                            <h5 class="mb-0">@Model.ProductName</h5>
                            <small class="text-muted">@Model.ProductType â€¢ Version @Model.Version</small>
                        </div>
                        <div class="ms-auto">
                            @if (Model.IsActive)
                            {
                                <span class="badge bg-success me-2">Active</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary me-2">Inactive</span>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div> <!-- Statistics Cards -->
    <partial name="_StatsTiles" model="Model.StatsTiles" />

    <div class="row g-2">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Alert container -->
            <div id="alert-container" class="mb-3"></div>

            <!-- Features Management -->
            <div class="edit-section">
                <div class="section-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-star me-2"></i>Product Features
                        </h5>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-secondary btn-sm active" id="cardViewBtn"
                                onclick="switchView('card')">
                                <i class="fas fa-th-large me-1"></i>Cards
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="listViewBtn"
                                onclick="switchView('list')">
                                <i class="fas fa-list me-1"></i>List
                            </button>
                        </div>
                    </div>
                </div>
                <div class="section-content">
                    <!-- Features content -->
                    <div id="features-content">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-3 text-muted">Loading product features...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Quick Actions -->
            <div class="sidebar-section">
                <div class="section-header">
                    <h6><i class="fas fa-bolt me-2"></i>Quick Actions</h6>
                </div>
                <div class="section-content">
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-outline-primary" onclick="showAddFeatureModal()">
                            <i class="fas fa-plus me-2"></i>Add Feature
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="importFeaturesFromJson()">
                            <i class="fas fa-upload me-2"></i>Import Features
                        </button>
                        <button type="button" class="btn btn-outline-info" onclick="copyToAnotherProduct()">
                            <i class="fas fa-copy me-2"></i>Copy to Product
                        </button>
                        <button type="button" class="btn btn-outline-success" onclick="exportToJson()">
                            <i class="fas fa-download me-2"></i>Export to JSON
                        </button>
                        <a href="@Url.Action("Details", new { id = Model.ProductId })" class="btn btn-outline-warning">
                            <i class="fas fa-info-circle me-2"></i>Product Details
                        </a>
                        <a asp-controller="License" asp-action="Create" asp-route-productId="@Model.ProductId"
                            class="btn btn-outline-success">
                            <i class="fas fa-certificate me-2"></i>Generate License
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden fields for JavaScript -->
<input type="hidden" id="productId" value="@Model.ProductId" />
<input type="hidden" id="productName" value="@Model.ProductName" />
<input type="hidden" id="getFeaturesUrl" value="@Url.Action("GetProductFeatures")" />
<input type="hidden" id="getFeatureUrl" value="@Url.Action("GetProductFeature")" />
<input type="hidden" id="addFeatureUrl" value="@Url.Action("AddProductFeature")" />
<input type="hidden" id="editFeatureUrl" value="@Url.Action("EditProductFeature")" />
<input type="hidden" id="deleteFeatureUrl" value="@Url.Action("DeleteProductFeature")" />

<!-- Add/Edit Feature Modal -->
<div class="modal fade" id="featureModal" tabindex="-1" aria-labelledby="featureModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="featureModalLabel">
                    <i class="fas fa-star me-2"></i>Add Product Feature
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="featureForm">
                <div class="modal-body">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="ProductId" value="@Model.ProductId" />

                    <div class="row g-3">
                        <!-- Feature Name -->
                        <div class="col-md-8">
                            <label for="featureName" class="form-label">
                                Feature Name <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="featureName" name="Name" required
                                maxlength="100" placeholder="Enter feature name">
                            <div class="invalid-feedback"></div>
                        </div>
                        
                        <!-- Category -->
                        <div class="col-md-4">
                            <label for="category" class="form-label">Category</label>
                            <select class="form-select" id="category" name="Category">
                                <option value="Core">Core</option>
                                <option value="Security">Security</option>
                                <option value="Performance">Performance</option>
                                <option value="BusinessIntelligence">Business Intelligence</option>
                                <option value="Integration">Integration</option>
                                <option value="Other">Other</option>
                            </select>
                            <div class="invalid-feedback"></div>
                        </div>
                        
                        <!-- Description -->
                        <div class="col-12">
                            <label for="featureDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="featureDescription" name="Description" rows="2"
                                maxlength="500" placeholder="Describe what this feature does..."></textarea>
                            <div class="form-text">Maximum 500 characters</div>
                            <div class="invalid-feedback"></div>
                        </div>

                        <!-- Minimum Tier -->
                        <div class="col-md-6">
                            <label for="minimumTier" class="form-label">Minimum Tier</label>
                            <select class="form-select" id="minimumTier" name="MinimumTier">
                                <!-- Options will be populated dynamically from product tiers -->
                                <option value="">Loading tiers...</option>
                            </select>
                            <div class="form-text">The minimum license tier required for this feature</div>
                            <div class="invalid-feedback"></div>
                        </div>
                        
                        <!-- Usage Limit -->
                        <div class="col-md-6">
                            <label for="maxUsage" class="form-label">Usage Limit</label>
                            <input type="number" class="form-control" id="maxUsage" name="MaxUsage" min="0"
                                placeholder="Leave empty for unlimited">
                            <div class="form-text">Maximum number of times this feature can be used</div>
                            <div class="invalid-feedback"></div>
                        </div>

                        <!-- Status Checkboxes -->
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="isEnabled" name="IsEnabled" value="true" checked>
                                <label class="form-check-label" for="isEnabled">
                                    Enabled by Default
                                </label>
                            </div>
                            <small class="text-muted">Feature will be automatically enabled for new licenses</small>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="isActive" name="IsActive" value="true" checked>
                                <label class="form-check-label" for="isActive">
                                    Active
                                </label>
                            </div>
                            <small class="text-muted">Feature is available for use in the system</small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" id="featureSubmitBtn">
                        <i class="fas fa-save me-2"></i>Add Feature
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Import Features Modal -->
<div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importModalLabel">Import Features</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">

                <div class="mb-3">
                    <label for="importJson" class="form-label">Paste JSON or upload file</label>
                    <textarea class="form-control" id="importJson" rows="10"
                        placeholder='[{"name": "Feature Name", "description": "Feature Description", "category": "Core"}]'></textarea>
                </div>
                <div class="mb-3">
                    <label for="importFile" class="form-label">Or upload a JSON file</label>
                    <input type="file" class="form-control" id="importFile" accept=".json">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="importBtn">Import Features</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/product-features.js"></script>
    <script>
        // Handle checkbox form submission to ensure proper boolean values
        $(document).ready(function() {
            // Intercept form submission to handle checkbox values
            $('#featureForm').on('submit', function(e) {
                // Handle IsEnabled checkbox
                var isEnabledCheckbox = $('#isEnabled');
                if (!isEnabledCheckbox.is(':checked')) {
                    // Add hidden field for false value if checkbox is unchecked
                    $('<input>').attr({
                        type: 'hidden',
                        name: 'IsEnabled',
                        value: 'false'
                    }).appendTo(this);
                }
                
                // Handle IsActive checkbox
                var isActiveCheckbox = $('#isActive');
                if (!isActiveCheckbox.is(':checked')) {
                    // Add hidden field for false value if checkbox is unchecked
                    $('<input>').attr({
                        type: 'hidden',
                        name: 'IsActive',
                        value: 'false'
                    }).appendTo(this);
                }
            });
        });
    </script>
}