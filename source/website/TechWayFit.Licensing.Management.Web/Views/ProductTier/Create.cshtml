@model TechWayFit.Licensing.Management.Web.ViewModels.Product.ProductTierViewModel

@{
    ViewData["Title"] = "Create Product Tier";
    
    // Get configuration data
    var supportedCurrencies = ViewData["SupportedCurrencies"] as List<TechWayFit.Licensing.Management.Web.Configuration.Currency>;
    
    // Prepare header data
    var headerModel = new TechWayFit.Licensing.Management.Web.ViewModels.Shared.PageHeaderViewModel
    {
        Title = "Create Product Tier",
        Icon = "fas fa-layer-group",
        BreadcrumbItems = new List<TechWayFit.Licensing.Management.Web.ViewModels.Shared.BreadcrumbItem>
        {
            new() { Text = "Dashboard", Controller = "License", Action = "Index" },
            new() { Text = "Products", Controller = "Product", Action = "Index" },
            new() { Text = "Product Tiers", Controller = "ProductTier", Action = "Index", RouteValues = new { productId = Model.ProductId } },
            new() { Text = "Create", IsActive = true }
        },
        BackButtonText = "Back to Product Tiers",
        BackButtonController = "ProductTier",
        BackButtonAction = "Index",
        BackButtonRouteValues = new { productId = Model.ProductId }
    };
}

@section styles {
    <style>
        .tier-form {
            background: white;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .form-section {
            margin-bottom: 32px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            background-color: #fafbfc;
        }
        
        .form-section h5 {
            color: #495057;
            margin-bottom: 20px;
            font-weight: 600;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 8px;
        }
        
        .sla-section {
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 20px;
            background-color: #f8f9ff;
            margin-top: 24px;
        }
        
        .sla-section h5 {
            color: #0056b3;
            border-bottom: 2px solid #007bff;
        }
        
        .form-row {
            margin-bottom: 16px;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .sla-response-time {
            margin-bottom: 20px;
        }
        
        .sla-response-time .form-label {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .sla-response-time .form-control {
            text-align: center;
        }
        
        .price-row {
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 16px;
            margin-bottom: 16px;
            background-color: #ffffff;
        }
        
        .currency-select {
            min-width: 100px;
        }
        
        .btn-group {
            gap: 12px;
        }
        
        .required-field {
            color: #dc3545;
        }
        
        .form-label {
            font-weight: 500;
            color: #495057;
        }
    </style>
}

@await Html.PartialAsync("_PageHeaderPartial", headerModel)

<div class="container-fluid">
    <!-- Alert Messages -->
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle"></i>
            @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle"></i>
            @TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <form asp-action="Create" asp-route-productId="@Model.ProductId" method="post" class="needs-validation" novalidate>
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="ProductId" />
        
        <div class="row">
            <!-- Main Content -->
            <div class="col-lg-8 col-md-10">
                <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>
                
                <!-- Basic Information Section -->
                <div class="form-section">
                    <h5><i class="fas fa-info-circle me-2"></i>Basic Information</h5>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label asp-for="Name" class="form-label">
                                    Tier Name <span class="required-field">*</span>
                                </label>
                                <input asp-for="Name" class="form-control" placeholder="Enter tier name" required />
                                <span asp-validation-for="Name" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label asp-for="DisplayOrder" class="form-label">Display Order</label>
                                <input asp-for="DisplayOrder" class="form-control" type="number" min="0" />
                                <span asp-validation-for="DisplayOrder" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <div class="form-group">
                                <label asp-for="Description" class="form-label">Description</label>
                                <textarea asp-for="Description" class="form-control" rows="3" placeholder="Enter tier description"></textarea>
                                <span asp-validation-for="Description" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Support SLA Configuration Section -->
                <div class="form-section sla-section">
                    <h5><i class="fas fa-headset me-2"></i>Support SLA Configuration</h5>
                    
                    <!-- SLA Template Selector -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <label class="form-label">Quick SLA Template Selection</label>
                            <select id="slaTemplateSelector" class="form-select">
                                <option value="">Select a pre-configured SLA template...</option>
                                @foreach (var template in (List<TechWayFit.Licensing.Management.Web.Configuration.SLATemplate>)ViewData["SLATemplates"]!)
                                {
                                    <option value="@template.Id" 
                                            data-name="@template.Name" 
                                            data-description="@template.Description"
                                            data-critical="@template.CriticalResponseHours"
                                            data-high="@template.HighPriorityResponseHours"
                                            data-medium="@template.MediumPriorityResponseHours"
                                            data-low="@template.LowPriorityResponseHours">
                                        @template.Name - @template.Description
                                    </option>
                                }
                            </select>
                            <small class="form-text text-muted">Choose a template to automatically fill in the SLA values, or manually enter your own values below.</small>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label asp-for="SLAName" class="form-label">SLA Name</label>
                                <input asp-for="SLAName" class="form-control" placeholder="e.g., Premium Support" />
                                <span asp-validation-for="SLAName" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label asp-for="SLADescription" class="form-label">SLA Description</label>
                                <input asp-for="SLADescription" class="form-control" placeholder="Brief description of the support level" />
                                <span asp-validation-for="SLADescription" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-lg-3 col-md-6">
                            <div class="form-group sla-response-time">
                                <label asp-for="CriticalResponseHours" class="form-label" title="Critical Response Time (Hours)">Critical Response (Hours)</label>
                                <input asp-for="CriticalResponseHours" type="number" step="0.5" min="0.5" class="form-control" placeholder="1.0" />
                                <span asp-validation-for="CriticalResponseHours" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="form-group sla-response-time">
                                <label asp-for="HighPriorityResponseHours" class="form-label" title="High Priority Response Time (Hours)">High Priority (Hours)</label>
                                <input asp-for="HighPriorityResponseHours" type="number" step="0.5" min="0.5" class="form-control" placeholder="4.0" />
                                <span asp-validation-for="HighPriorityResponseHours" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="form-group sla-response-time">
                                <label asp-for="MediumPriorityResponseHours" class="form-label" title="Medium Priority Response Time (Hours)">Medium Priority (Hours)</label>
                                <input asp-for="MediumPriorityResponseHours" type="number" step="0.5" min="0.5" class="form-control" placeholder="8.0" />
                                <span asp-validation-for="MediumPriorityResponseHours" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="form-group sla-response-time">
                                <label asp-for="LowPriorityResponseHours" class="form-label" title="Low Priority Response Time (Hours)">Low Priority (Hours)</label>
                                <input asp-for="LowPriorityResponseHours" type="number" step="0.5" min="0.5" class="form-control" placeholder="24.0" />
                                <span asp-validation-for="LowPriorityResponseHours" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Limits Section -->
                <div class="form-section">
                    <h5><i class="fas fa-users me-2"></i>Usage Limits</h5>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label asp-for="MaxUsers" class="form-label">Maximum Users</label>
                                <input asp-for="MaxUsers" class="form-control" type="number" min="0" placeholder="0 = unlimited" />
                                <span asp-validation-for="MaxUsers" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label asp-for="MaxDevices" class="form-label">Maximum Devices</label>
                                <input asp-for="MaxDevices" class="form-control" type="number" min="0" placeholder="0 = unlimited" />
                                <span asp-validation-for="MaxDevices" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pricing Section -->
                <div class="form-section">
                    <h5><i class="fas fa-dollar-sign me-2"></i>Pricing</h5>
                    
                    <!-- Monthly Pricing -->
                    <div class="price-row">
                        <h6 class="mb-3"><i class="fas fa-calendar-alt"></i> Monthly Pricing</h6>
                        <div class="row">
                            <div class="col-md-8">
                                <label asp-for="MonthlyPriceAmount" class="form-label">Monthly Price</label>
                                <input asp-for="MonthlyPriceAmount" class="form-control" type="number" step="0.01" min="0" placeholder="0.00" />
                                <span asp-validation-for="MonthlyPriceAmount" class="text-danger"></span>
                            </div>
                            <div class="col-md-4">
                                <label asp-for="MonthlyPriceCurrency" class="form-label">Currency</label>
                                <select asp-for="MonthlyPriceCurrency" class="form-select currency-select">
                                    @if (supportedCurrencies != null)
                                    {
                                        @foreach (var currency in supportedCurrencies)
                                        {
                                            <option value="@currency.Code" selected="@(currency.IsDefault ? "selected" : null)">@currency.Code (@currency.Symbol)</option>
                                        }
                                    }
                                    else
                                    {
                                        <option value="USD">USD ($)</option>
                                        <option value="EUR">EUR (€)</option>
                                        <option value="GBP">GBP (£)</option>
                                    }
                                </select>
                                <span asp-validation-for="MonthlyPriceCurrency" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Annual Pricing -->
                    <div class="price-row">
                        <h6 class="mb-3"><i class="fas fa-calendar"></i> Annual Pricing</h6>
                        <div class="row">
                            <div class="col-md-8">
                                <label asp-for="AnnualPriceAmount" class="form-label">Annual Price</label>
                                <input asp-for="AnnualPriceAmount" class="form-control" type="number" step="0.01" min="0" placeholder="0.00" />
                                <span asp-validation-for="AnnualPriceAmount" class="text-danger"></span>
                            </div>
                            <div class="col-md-4">
                                <label asp-for="AnnualPriceCurrency" class="form-label">Currency</label>
                                <select asp-for="AnnualPriceCurrency" class="form-select currency-select">
                                    @if (supportedCurrencies != null)
                                    {
                                        @foreach (var currency in supportedCurrencies)
                                        {
                                            <option value="@currency.Code" selected="@(currency.IsDefault ? "selected" : null)">@currency.Code (@currency.Symbol)</option>
                                        }
                                    }
                                    else
                                    {
                                        <option value="USD">USD ($)</option>
                                        <option value="EUR">EUR (€)</option>
                                        <option value="GBP">GBP (£)</option>
                                    }
                                </select>
                                <span asp-validation-for="AnnualPriceCurrency" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status Section -->
                <div class="form-section">
                    <h5><i class="fas fa-toggle-on me-2"></i>Status</h5>
                    
                    <div class="form-check">
                        <input asp-for="IsActive" class="form-check-input" type="checkbox" />
                        <label asp-for="IsActive" class="form-check-label">
                            Active (Available for licensing)
                        </label>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="d-flex justify-content-end btn-group mt-4">
                    <a href="@Url.Action("Index", new { productId = Model.ProductId })" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Cancel
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Create Tier
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

@section scripts {
    <script>
        $(document).ready(function() {
            // SLA Template selector functionality
            $('#slaTemplateSelector').on('change', function() {
                const selectedOption = $(this).find('option:selected');
                
                if (selectedOption.val()) {
                    // Fill in the SLA fields with template data
                    $('#SLAName').val(selectedOption.data('name'));
                    $('#SLADescription').val(selectedOption.data('description'));
                    $('#CriticalResponseHours').val(selectedOption.data('critical'));
                    $('#HighPriorityResponseHours').val(selectedOption.data('high'));
                    $('#MediumPriorityResponseHours').val(selectedOption.data('medium'));
                    $('#LowPriorityResponseHours').val(selectedOption.data('low'));
                    
                    // Add visual feedback
                    $('.sla-section input').addClass('border-success').removeClass('border-warning');
                    
                    // Show success message
                    const alertHtml = `
                        <div class="alert alert-success alert-dismissible fade show mt-2" role="alert" id="slaTemplateAlert">
                            <i class="fas fa-check-circle"></i>
                            SLA template "${selectedOption.data('name')}" has been applied successfully!
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    `;
                    
                    // Remove existing alert and add new one
                    $('#slaTemplateAlert').remove();
                    $('.sla-section h5').after(alertHtml);
                    
                    // Auto-dismiss after 3 seconds
                    setTimeout(function() {
                        $('#slaTemplateAlert').fadeOut();
                    }, 3000);
                } else {
                    // Clear the success styling when no template is selected
                    $('.sla-section input').removeClass('border-success border-warning');
                    $('#slaTemplateAlert').remove();
                }
            });

            // Auto-sync currency selections
            $('#MonthlyPriceCurrency').on('change', function() {
                if (!$('#AnnualPriceAmount').val()) {
                    $('#AnnualPriceCurrency').val($(this).val());
                }
            });

            $('#AnnualPriceCurrency').on('change', function() {
                if (!$('#MonthlyPriceAmount').val()) {
                    $('#MonthlyPriceCurrency').val($(this).val());
                }
            });

            // Form validation enhancement
            $('form').on('submit', function(e) {
                const monthlyPrice = parseFloat($('#MonthlyPriceAmount').val()) || 0;
                const annualPrice = parseFloat($('#AnnualPriceAmount').val()) || 0;
                
                if (monthlyPrice === 0 && annualPrice === 0) {
                    e.preventDefault();
                    alert('Please specify at least one price (monthly or annual) for this tier.');
                    return false;
                }
                
                return true;
            });

            // Auto-dismiss alerts after 5 seconds
            setTimeout(function() {
                $('.alert').fadeOut();
            }, 5000);
        });
    </script>
}
